---
title: 'Tipología y ciclo de vida de los datos: PRA2'
author: "Autor: Pablo Benito y Miquel Rived"
date: "Junio 2021"
output:
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
    includes:
      in_header: PEC-header.html
  pdf_document:
    highlight: zenburn
    toc: yes
  word_document: default
editor_options: 
  chunk_output_type: inline
---

******
# Cargar el archivo

<span style="color: red;">**RÚBRICA** Apartados 1,2,3 y 4: 30%.</span>

> Se debe abrir el archivo de datos y examinar el tipo de datos con los que R ha interpretado cada variable. Examinar también los valores resumen de cada tipo de variable.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Cargamos los paquetes R que vamos a usar
library(ggplot2)
library(dplyr)
library(knitr)
library(stringr)
library(lubridate)
library(purrr)
library(RcmdrMisc)
# library(ggbiplot)
library(summarytools)
library(kableExtra)

```

En primer lugar cargamos el archivo utilizando la función `read.csv`. añadimos el parámetro `stringsAsFactors=False` para que no convierta en factores los atributos que detecte como `String`. Posteriormente, nosotros realizaremos esa conversión para aquellos campos que consideremos oportuno.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Cargamos el fichero de datos
data <- read.csv('dpreview.csv',stringsAsFactors = FALSE)
```

Verificamos el tipo de datos asignado por R a cada atributo utilizando el comando `str` (`structure`):

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Verificamos la estructura del conjunto de datos
str(data)
```

Los atributos identificados, junto a su significado se resumen en la siguiente tabla:

```{r echo=TRUE, message=FALSE, warning=FALSE,result='asis'}
description_df <- data.frame (
                    #campo  = colnames(data),
                    tipo = sapply(data, class),
                    descripción = c(
                      "Velocidad de obturación máxima .",
                      "Puntuación de review",
                      "Puntuación calidad de construcción",
                      "Número de puntos de enfoque",
                      "Tipo de autofoco",
                      "Enlace a la página",
                      "Formatos de almacenamiento de vídeo",
                      "Pantalla táctil",
                      "Marca",
                      "Puntos de la pantalla",
                      "Disparos en modo ráfaga",
                      "Conexión para micrófono",
                      "Velocidad de obturación mínima",
                      "Prioridad de obturador",
                      "Dimensiones",
                      "Número de lentes",
                      "Puntuación de rendimiento",
                      "Enlace a la review",
                      "Amplificación del visor",
                      "Observaciones sobre la estabilización de imagen",
                      "Puntuación de calidad de pantalla",
                      "Observaciones sobre GPS",
                      "Número de usuarios que poseen la cámara",
                      "ISO mínimo",
                      "Puntuación de visor",
                      "Puntuación de velocidad y respuesta",
                      "Zoom óptico",
                      "Número de usuarios que desean tener la cámara",
                      "Modos de flash",
                      "Balances de blancos personalizados",
                      "Formato sin compresión",
                      "Fecha de publicación",
                      "Grabación de timelapse",
                      "Preajustes de balances de blancos",
                      "Multiplicador de la distancia focal",
                      "Resolución máxima",
                      "Puntuación de calidad de vídeo",
                      "Vista en directo",
                      "Descripción de la batería",
                      "Resolución del sensor",
                      "ISO máximo",
                      "Tipo de pantalla",
                      "Familia de la cámara",
                      "Puntuación de imagen fija",
                      "Cobertura del visor",
                      "Mando a distancia",
                      "Puntuación general",
                      "Tamaño del sensor",
                      "Velocidad de obturación máxima",
                      "Modos de medición",
                      "Estanqueidad",
                      "Observaciones sobre conexión inalámbrica",
                      "Distancia focal equivalente",
                      "Modelo de cámara",
                      "Formato de bateria",
                      "Resolución del visor",
                      "Puntuación de modo vídeo",
                      "Modo de pantalla articulada",
                      "Puntuación de calidad de imagen en RAW.",
                      "Puntuación de conectividad",
                      "Premio (Gold, Silver)",
                      "Niveles de calidad JPEG",
                      "Tamaño de la pantalla",
                      "Peso con batería", # Extraer gramos por expresión regular
                      "Píxeles efectivos",
                      "Especificaciones rápidas",
                      "Montura de lente",
                      "Modo de exposición manual",
                      "Puntuación de medición y enfoque",
                      "Tipo de sensor",
                      "Distancia mínima de enfoque",
                      "Durabilidad",
                      "Altavoz",
                      "Resoluciones",
                      "Número de usuarios que han poseido la cámara",
                      "Puntuación de calidad de imagen JPG",
                      "Puntuación de la óptica",
                      "Tipo de visor",
                      "Precio recomendado", # extraer mediante expresión regular el número
                      "Puntuación de ergonomía y manejo",
                      "Puntuación de rendimiento de flash",
                      "GPS",
                      "Puntuación de rendimiento en velocidad",
                      "Cuenta atrás",
                      "USB",
                      "Otras resoluciones",
                      "Puntuación de características",
                      "Wireless",
                      "Flash incluido",
                      "Compensación de la exposición",
                      "Puntuación de exactitud de exposición y enfoque",
                      "Puntuación de ergonomía y manejo",
                      "Flash externo",
                      "AE Bracketing",
                      "Ciclos de vida de la batería",
                      "Carga por USB",
                      "HDMI",
                      "Modos",
                      "Zoom digital",
                      "Apertura máxima",
                      "Rango del flash",
                      "ISO",
                      "Puntuación de review (porcentaje)",
                      "Modos de escena",
                      "Enfoque manual",
                      "Estabilización de imagen",
                      "Prioridad de apertura",
                      "Orientación del sensor" ,
                      "Puntuación CIPA de estabilización de imagen",
                      "Observaciones sobre grabación en vídeo",
                      "URL de imagen de la cámara",
                      "Tipo de micrófono",
                      "Puntuación con rendimeinto con luz baja e ISO alto",
                      "Campo de visión",
                      "Bracketing de balance de blancos",
                      "Puntuación de las características de la camera y fotografía",
                      "Procesador",
                      "Ratio de imagen ancho x alto",
                      "Distancia mínima modo macro",
                      "Tipo de cuerpo", # IMPORTANTE
                      "Conector de cascos",
                      "Número de reviews", # Extraer número con expresión regular
                      "Tipos de almacenamientos", 
                      "Número de puntos de enfoque", # IMPORTANTE
                      "Almacenamiento incluido") 
                  )

kable(description_df,caption="**Propiedades de las cámaras**") %>% kable_styling()
```

Vamos a realizar una inspección rápida de los atributos mediante el comando `summary`

```{r echo=TRUE, message=FALSE, warning=FALSE}
summary(data)
```

Veamos que aspecto tienen los datos mostrando las primeras filas:

```{r echo=TRUE, message=FALSE, warning=FALSE}
head(data)
```



# Reducción de la dimensionalidad
Seleccionamos exclusivamente con las siguientes columnas, además, para facilitar el análisis posterior, las renombramos a los nombres indicados.

## Variables cuantitativas

- Los relativos a la **puntuación del equipo de expertos** de dpreview:
  - `review_score`: Puntuación de la review. Renombramos a `puntuacion.review`
  - `Build.quality`: Puntuación calidad de construcción. Renombramos a `puntuacion.calidad_construccion`
  - `Performance`: Puntuación del rendimiento. Renombramos a `puntuación.rendimiento`
  - `Screen.Quality`: Puntuación de la calidad de la pantalla. Renombramos a `puntuacion.calidad.pantalla`
  - `Viewfinder…screen.rating`: Puntuación del visor. Renombramos a `puntuacion.visor`
  - `Speed.and.Responsiveness`: Puntuación velocidad y respuesta. Renombramos a `puntuacion.velocidad_respuesta`
  - `Video.Quality`: Puntuación de calidad de vídeo. Renombramos a `puntuacion.calidad_video`
  - `Still.Image.Quality`: Puntuación de imagen fija. Renombramos a `puntuacion.calidad_imagen_fija`
  - `Value`: Puntuación general. Renombramos a `puntuacion.general`
  - `Movie…video.mode`: Puntuación del modo vídeo. Renombramos a `puntuacion.modo_video`
  - `Image.quality..raw.`: Puntuación de la calidad de imagen RAW. Renombramos a `puntuacion.calidad_raw`
  - `Connectivity`: Puntuación de conectividad. Renombramos a `puntuacion.conectividad`
  - `Metering…focus.accuracy`: Puntuación de medición y enfoque. Renombramos a `puntuacion.precision`
  - `Image.quality..jpeg.`: Puntuación de imagen JPG. Renombramos a `puntuacion.calidad_jpg`
  - `Optics`: Puntuación de óptica. Renombramos a `puntuacion.optica`
  - `Ergonomics...handling`: Puntuación de ergonomía y manejo. Renombramos a `puntuacion.ergonomia_manejo`
  - `Flash.performance`: Puntuación de rendimiento del flash. Renombramos a `puntuacion.rendimento_flash`
  - `Performance..speed.`: Puntuación de rendimiento en velocidad. Renombramos a `puntuacion.rendimiento_velocidad`
  - `Features`: Puntuación de características. Renombramos a `puntuacion.caracteristicas`
  - `Exposure.and.focus.accuracy`: Puntuación de precisión de exposición y enfoque. Renombramos a `puntuacion.precision_exposicion_enfoque`
  - `review_value`: Puntuación de review (porcentaje). Renombramos a `puntuacion.review`
  - `Low.light…high.ISO.performance`: Puntuación con rendimeinto con luz baja e ISO alto. Renombramos a `puntuacion.luz_baja_alto_ISO`
  - `Camera.and.Photo.Features`: Puntuación de las características de la camera y fotografía. Renombramos a `puntuacion.caracteristicas_camara_foto`
  
```{r echo=TRUE, message=FALSE, warning=FALSE}
data<- rename(data,
               puntuacion.calidad_construccion=Build.quality,
               puntuación.rendimiento=Performance,
               puntuacion.calidad.pantalla=Screen.Quality,
               puntuacion.visor=Viewfinder...screen.rating,
               puntuacion.velocidad_respuesta=Speed.and.Responsiveness,
               puntuacion.calidad_video=Video.Quality,
               puntuacion.calidad_imagen_fija=Still.Image.Quality,
               puntuacion.general=Value,
               puntuacion.modo_video=Movie...video.mode,
               puntuacion.puntuacion_calidad_raw=Image.quality..raw.,
               puntuacion.conectividad=Connectivity,
               puntuacion.precision=Metering...focus.accuracy,
               puntuacion.calidad_jpg=Image.quality..jpeg.,
               puntuacion.optica=Optics,
               puntuacion.ergonomia_manejo=Ergonomics...handling,
               puntuacion.rendimento_flash=Flash.performance,
               puntuacion.rendimiento_velocidad=Performance..speed.,
               puntuacion.caracteristicas=Features,
               puntuacion.precision_exposicion_enfoque=Exposure.and.focus.accuracy,
               puntuacion.pro_review=review_value,
               puntuacion.luz_baja_alto_ISO=Low.light...high.ISO.performance,
               puntuacion.caracteristicas_camara_foto=Camera.and.Photo.Features)
```

- Las relativos a las **características físicas de la cámara**:
  - `Weight..inc..batteries`: Peso. Renombramos a `caracteristicas.peso`
  - `Dimensions`: Dimensiones (ancho x alto x fondo). Renombramos a `caracteristicas.dimensiones`

```{r echo=TRUE, message=FALSE, warning=FALSE}
data<- rename(data,
               caracteristicas.peso=Weight..inc..batteries.,
               caracteristicas.dimensiones=Dimensions)
```
- Las relativas al **interés por parte de los usuarios de la comunidad** de dpreview: 
   - own_gear. Renombramos a `usuario.tiene`
   - had_gear. Renombramos a `usuario.ha_tenido`
   - want_gear. Renombramos a `usuario.desea`
   - review_score: Puntuación media por parte de los usuarios de la comunidad. Renombramos a `usuario.puntuacion`

```{r echo=TRUE, message=FALSE, warning=FALSE}
data<- rename(data,
               usuario.tiene=own_gear,
               usuario.ha_tenido=had_gear,
               usuario.desea=want_gear,
               usuario.puntuacion=review_score)
```

- El **precio de la cámara**: `MSRP`. Renombramos a `precio`

```{r echo=TRUE, message=FALSE, warning=FALSE}
data<- rename(data,
               precio=MSRP)
```

- Las relativas a **características técnicas** de la cámara: 
    - `Max.resolution`: resolución, renombramos a `caracteristicas.resolucion`
    -` Maximum.shutter.speed`: velocidad máxima de obturador, renombramos a `caracteristicas.velocidad_obturador`
    
```{r echo=TRUE, message=FALSE, warning=FALSE}
data<- rename(data,
               caracteristicas.resolucion=Max.resolution,
               caracteristicas.velocidad_obturador=Maximum.shutter.speed
              )
```

  
## Variables cualitativas
- Marca y  modelo de la cámara:
    - `Brand`: Marca, renombramos a `marca`
    - `name`: Modelo, renombramos a `modelo`
- Otras características:
    - `Body.type`: Tipo de cuerpo, renombramos a `tipo_cuerpo`
    - `Sensor.type`: Tipo de sensor, renombramos a `tipo_sensor`
    - `announcement_date`: Fecha de lanzamiento, renombramos a `fecha_lanzamiento`

```{r echo=TRUE, message=FALSE, warning=FALSE}
data<- rename(data,
               marca=brand,
               modelo=name,
               tipo_cuerpo=Body.type,
               tipo_sensor=Sensor.type,
               fecha_lanzamiento=announcement_date
              )

```

Convertimos a factor los atributos:
```{r echo=TRUE, message=FALSE, warning=FALSE}
data$marca<-as.factor(data$marca)
data$tipo_cuerpo<-as.factor(data$tipo_cuerpo)
data$tipo_sensor<-as.factor(data$tipo_sensor)
data$caracteristicas.velocidad_obturador<-as.factor(data$caracteristicas.velocidad_obturador)
```

Finalmente aplicamos la reducción de la dimensionalidad, filtrando únicamente las columnas que nos interesan

```{r echo=TRUE, message=FALSE, warning=FALSE}
data <- data[ , grepl( "puntuacion|caracteristicas|tipo_|fecha_lanzamiento|marca|modelo|precio" , names( data ) ) ]
```

# Extraccción de valores numéricos

## Atributo `precio`
Los valores de la columna `precio` tiene diversos tipos de valores. En la mayoría de las filas contiene un único precio en dólares, precedido del símbolo de dolar (p.ej. `$899`), pero en algunos casos incluye varios precios en función del kit a comprar (con objetivo, sin objetivo, con varios ojetivos,...) y en otros casos se muestra el precio tanto en dólares como en otras monedas (euro y libras).

Para simplificar la extracción, nos quedaremos con el primer precio que aparezca precedido del símbolo del dólar utilizando una expresión regular. 

Otras posibles alternativas en el tratamiento de este atributo podría haber sido obtener todos los posibles valores precedidos del símbolo dólar y quedarnos con el máximo, o hacer una conversión entre divisas según el cambio euro->dólar y libra->dolar.


```{r echo=TRUE, message=FALSE, warning=FALSE}

data$precio<-as.integer(str_extract(str_extract(data$precio, "(\\$\\d+)"),"(\\d+)"))
```


## Atributo `puntuacion.pro_review`

Este atributo contiene un porcentaje que incluye el símbolo `%`. Interesa convertirlo a entero y eliminar ese porcentaje. Utilizaremos para ello una expresión regular y la función `str_extract` del paquete `stringr`

```{r echo=TRUE, message=FALSE, warning=FALSE}

data$puntuacion.pro_review<-as.integer(str_extract(data$puntuacion.pro_review, "(\\d+)"))
```

## Atributo `caracteristicas.peso`

Este atributo expresa el peso tanto en gramos como en libras y onzas. Utilizaremos una expresión regular para quedarnos con el peso en gramos

```{r echo=TRUE, message=FALSE, warning=FALSE}

data$caracteristicas.peso<-as.integer(str_extract(data$caracteristicas.peso, "(\\d+)"))

```

# Extracción de fecha

La fecha de lanzamiento de la cámara viene especificada en el atributo `fecha_lanzamiento`. El formato del campo varía en función de si el lanzamiento ha sido hace menos de un año (p.ej. "`Announced 7 months ago`"), o hace más de un año (p.ej. "`Announced Jan 15, 2016`"). En cualquier caso, de cara al análisis sólo nos interesa quedarnos con el año de lanzamiento. Utilizaremos una expresión regular para obtener el año, y en caso de que no tenga éxito, asignaremos el valor actual.

```{r echo=TRUE, message=FALSE, warning=FALSE}

data$fecha_lanzamiento <- as.integer(str_extract(data$fecha_lanzamiento, "(\\d\\d\\d\\d)"))
# Asignamos por defecto al año 2020
data[is.na(data$fecha_lanzamiento),"fecha_lanzamiento"] = 2020

```

# Comprobar atributos con valores vacíos

Asignar `NA` a los atributos con valor cadena vacía
```{r echo=TRUE, message=FALSE, warning=FALSE}
#data <- data %>% mutate_all(list(~na_if(.,"")))
```
```{r echo=TRUE, message=FALSE, warning=FALSE}
#na_count <-data.frame(sapply(data, function(y) sum(length(which(is.na(y))))))
#na_count
```

Eliminamos todos aquellos atributos tipo "puntuación" que tengan más del 10% de atributos con valor `NA`

```{r echo=TRUE, message=FALSE, warning=FALSE}
#https://stackoverflow.com/questions/31848156/delete-columns-rows-with-more-than-x-missing
# Esto no lo haría porque creo que nos estamos cargando el precio
data.puntuacion <- data%>%select(starts_with("puntuacion"))
atributes_to_remove<-colnames(data.puntuacion[, which(colMeans(!is.na(data.puntuacion)) > 0.1)])
data<-data %>% select(-atributes_to_remove)
print("Atributos eliminados:")
atributes_to_remove

```

# Verificar duplicación de registros

No existe un campo ID. Se puede verificar la existencia de duplicados mediante la combinación de campos Brand+Name.

Para comprobar si hay algún registro repetido utilizamos la función `unique` que proporciona los elementos únicos de una lista, en combinación con la función `nrow`, que obtiene el número de filas de un dataframe.
```{r echo=TRUE, message=FALSE, warning=FALSE}
if (nrow(unique(data[,c("brand","name")]))!=nrow(data[,c("brand","name")])){
  print("Hay alguna cámara repetida")
}else{
  print("No hay ninguna cámara repetida")
}
```


# Imputación de valores vacios

## Puntuaciones
Para las puntuaciones imputar la media de las cámaras de la misma marca y tipo de cámara.
Si no hay resultados, imputar la media del mismo tipo de cámara.
Si no hay resultados, imputar la media del atributo.



Para ajustarlos, **se imputan a estos registros el valor más común (moda) para el mismo empleado y motivación**:

```{r echo=TRUE, message=FALSE, warning=FALSE}
marcas <-unique(data$marca)
tipos_cuerpo <-unique(data$tipo_cuerpo)

for (p in colnames(data%>%select(starts_with("puntuacion")))){
  for (m in marcas){
    for (t in tipos_cuerpo){
      #media_marca_cuerpo<- mean(data %>% filter(marca==m,tipo_cuerpo==t)%>%select(p))
      media_marca_cuerpo<-0
      paste("---> ",m," ",t," ",p," -->Media:",media_marca_cuerpo)
    }
  }
}

```




# Valores extremos

```{r message= FALSE, warning=FALSE}
#boxplot(data$Value)
#out = boxplot.stats(data$Value)$out
#out
```


# Archivo final


Para guardar el `dataframe` resultado del procesamiento utilizamos la función `write.csv`:

```{r echo=TRUE, message=FALSE, warning=FALSE}
write.csv(data, 'dpreview_clean.csv', row.names = FALSE)
```


# Pruebas Estadísticas para comparación de los datos

# Pruebas de hipótesis

```{r message= FALSE, warning=FALSE}
#Review_GPS = filter(data, GPS == "Built-in" || GPS == "Optional")$Value
#Review_NoGPS = filter(data, GPS == "None")$Value
#f_obs = sd(Review_GPS)^2/sd(Review_NoGPS)^2
#f_obs
#qf(0.975,df1 = length(Review_GPS)-1, df2 = length(Review_NoGPS)-1)
```

#Regresión lineal

```{r message= FALSE, warning=FALSE}
#lineal_regression = lm(precio ~ XXXX, data = data)
#summary(lineal_regression)

```


# Referencias

* Identificar y eliminar duplicados: [https://www.datanovia.com/en/lessons/identify-and-remove-duplicate-data-in-r/]
* Tabla con medidas de tendencia central y dispersión: [https://cran.r-project.org/web/packages/qwraps2/vignettes/summary-statistics.html]
* My favourite R package for: summarising data [https://dabblingwithdata.wordpress.com/2018/01/02/my-favourite-r-package-for-summarising-data/]
